<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Auth Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .token-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .token-text {
            font-family: monospace;
            font-size: 0.85em;
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        .copy-button {
            position: relative;
            overflow: hidden;
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" th:href="@{/}">
                <i class="fas fa-shield-alt"></i> Auth Demo
            </a>
            
            <div class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/dashboard}">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item" th:if="${#lists.contains(roles, 'ROLE_ADMIN')}">
                    <a class="nav-link" th:href="@{/admin}">
                        <i class="fas fa-cog"></i> Admin
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i> 
                        <span th:text="${username}">User</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" th:href="@{/profile}">
                            <i class="fas fa-user"></i> Profile
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/logout}" method="post" style="margin: 0;">
                                <button type="submit" class="dropdown-item">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </button>
                            </form>
                        </li>
                    </ul>
                </li>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Profile Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <div class="profile-avatar mb-3">
                            <i class="fas fa-user"></i>
                        </div>
                        <h2 class="card-title mb-2">
                            <span th:text="${firstName + ' ' + lastName}">User Name</span>
                        </h2>
                        <p class="text-muted mb-3">
                            <i class="fas fa-at"></i> <span th:text="${email}">user@example.com</span>
                        </p>
                        <p class="text-muted">
                            <i class="fas fa-user-tag"></i> Username: <strong th:text="${username}">username</strong>
                        </p>
                        <div class="mt-3">
                            <span th:each="role, iter : ${roles}" 
                                  th:class="'badge me-1 ' + (role == 'ROLE_ADMIN' ? 'bg-danger' : (role == 'ROLE_MANAGER' ? 'bg-warning' : 'bg-success'))"
                                  th:text="${#strings.replace(role, 'ROLE_', '')}">ROLE</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- User Information -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i> User Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Keycloak ID:</dt>
                            <dd class="col-sm-8 text-muted" style="font-family: monospace; font-size: 0.9em;">
                                <span th:text="${user.subject}">subject-id</span>
                            </dd>

                            <dt class="col-sm-4">Username:</dt>
                            <dd class="col-sm-8"><span th:text="${username}">username</span></dd>

                            <dt class="col-sm-4">Email:</dt>
                            <dd class="col-sm-8"><span th:text="${email}">email</span></dd>

                            <dt class="col-sm-4">First Name:</dt>
                            <dd class="col-sm-8"><span th:text="${firstName}">First Name</span></dd>

                            <dt class="col-sm-4">Last Name:</dt>
                            <dd class="col-sm-8"><span th:text="${lastName}">Last Name</span></dd>

                            <dt class="col-sm-4">Roles:</dt>
                            <dd class="col-sm-8">
                                <div th:each="role : ${roles}">
                                    <span class="badge bg-primary me-1" th:text="${#strings.replace(role, 'ROLE_', '')}">ROLE</span>
                                </div>
                            </dd>

                            <dt class="col-sm-4">Email Verified:</dt>
                            <dd class="col-sm-8">
                                <span th:if="${user.emailVerified}" class="badge bg-success">
                                    <i class="fas fa-check"></i> Verified
                                </span>
                                <span th:unless="${user.emailVerified}" class="badge bg-warning">
                                    <i class="fas fa-exclamation"></i> Not Verified
                                </span>
                            </dd>
                        </dl>

                        <!-- Local Database User Info -->
                        <div th:if="${localUser}" class="mt-4">
                            <h6 class="text-muted">Local Database Record:</h6>
                            <ul class="list-unstyled text-muted small">
                                <li><strong>Created:</strong> <span th:text="${localUser.createdAt}">timestamp</span></li>
                                <li><strong>Updated:</strong> <span th:text="${localUser.updatedAt}">timestamp</span></li>
                                <li><strong>Enabled:</strong> 
                                    <span th:if="${localUser.enabled}" class="text-success">Yes</span>
                                    <span th:unless="${localUser.enabled}" class="text-danger">No</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Token Information -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-key"></i> Token Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Access Token -->
                        <div class="token-container">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Access Token</h6>
                                <button class="btn btn-sm btn-outline-primary copy-button" 
                                        onclick="copyToClipboard('access-token-text', this)">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div id="access-token-text" class="token-text" th:text="${accessToken}">
                                Access token content...
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> 
                                Expires: <span th:text="${tokenExpiry}">expiry time</span>
                            </small>
                        </div>

                        <!-- Refresh Token -->
                        <div class="token-container" th:if="${refreshToken}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Refresh Token</h6>
                                <button class="btn btn-sm btn-outline-secondary copy-button" 
                                        onclick="copyToClipboard('refresh-token-text', this)">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div id="refresh-token-text" class="token-text" th:text="${refreshToken}">
                                Refresh token content...
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Use this token to refresh your access token when it expires
                            </small>
                        </div>

                        <!-- Token Usage Examples -->
                        <div class="mt-3">
                            <h6>API Usage Example:</h6>
                            <div class="token-text">
curl -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
     http://localhost:8081/api/user/profile
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Testing Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-flask"></i> API Testing
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Test API endpoints with your current access token.</p>
                        
                        <div class="row g-3">
                            <!-- User Profile API -->
                            <div class="col-md-6">
                                <button class="btn btn-info w-100" onclick="testApi('/api/user/profile', 'user-api-result')">
                                    <i class="fas fa-user"></i> Test User Profile API
                                </button>
                                <div id="user-api-result" class="mt-2"></div>
                            </div>

                            <!-- User Session API -->
                            <div class="col-md-6">
                                <button class="btn btn-success w-100" onclick="testApi('/api/user/session', 'session-api-result')">
                                    <i class="fas fa-clock"></i> Test Session API
                                </button>
                                <div id="session-api-result" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p class="text-muted mb-0">
                &copy; 2024 Auth Demo - OAuth2 + Keycloak Integration
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        const accessToken = /*[[${accessToken}]]*/ '';

        function copyToClipboard(elementId, button) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.remove('btn-outline-primary', 'btn-outline-secondary');
                button.classList.add('btn-success');
                
                setTimeout(function() {
                    button.innerHTML = originalHtml;
                    button.classList.remove('btn-success');
                    button.classList.add(elementId.includes('access') ? 'btn-outline-primary' : 'btn-outline-secondary');
                }, 2000);
            });
        }

        function testApi(endpoint, resultId) {
            const resultDiv = document.getElementById(resultId);
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing...';
            
            fetch(endpoint, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(response => response.json())
            .then(data => {
                resultDiv.innerHTML = `
                    <div class="alert alert-success py-2 mt-2">
                        <small><strong>✓ Success</strong></small>
                        <pre class="mb-0 mt-1" style="font-size: 0.75em; max-height: 100px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger py-2 mt-2">
                        <small><strong>✗ Error:</strong> ${error.message}</small>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
